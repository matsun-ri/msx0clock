# msx0clock

## なんぞ
MSX0の向きによって表示が変わる置時計です。  
MSX0 Beginner kitに含まれている温度湿度センサ DHT20 が接続されている場合は、温度と湿度を表示します。  
MSX0の向きを変えたときのアニメーションをやってみたくて作りました。  

**動画(TouTube)**  
[![](https://img.youtube.com/vi/fNjlaWerbAA/0.jpg)](https://youtu.be/fNjlaWerbAA)


## 実行環境
- MSX0
  - 内蔵BDOS（時刻取得のため）
  - 内蔵MSXべーしっ君（高速化のため）
- Battery Bottom（の加速度センサー）
- 温度湿度センサ DHT20（必要に応じて）


## 実行方法
1. [CLOCK.DSK](https://github.com/matsun-ri/msx0clock/raw/main/CLOCK.DSK)をダウンロードし、MSX0のmicroSDカードのDSKフォルダ内に置きます。
2. MSX0のSetup Utilityにて、上記ディスクイメージを選択します。
3. MSX0をリセットします。
4. 自動的に起動します（MSXべーしっ君のコンパイルに数秒を要します）
5. キーボードが利用可能な状態であれば、ESCキーを押すと終了します。


## 変数の解説
- PT(n,x,y)<br>文字パターンをブロックに変換したもの(0-9,横,縦)
- SC(x,y)<br>時刻表示イメージ（現在の時刻をブロックに変換したもの）
- SX(),SY()<br>今の時刻表示イメージの各ブロックの座標
- DX(),DY()<br>↑と回転後との差分
- RN()<br>一意の乱数発生用
- P()<br>移動前・移動後のブロックの文字（移動前=● 移動後=○ ただし見かけは同じ）
- S()<br>移動処理用 添字が入る -1の場合は割当なし
- C()<br>移動処理用 移動進捗カウント
- D()<br>移動処理用 移動距離
- TX<br>一度に移動させるブロック数
- CL<br>文字色
- MX<br>SX(),SY(),MX(),MY()の最大数（ブロックの総数）
- LX<br>SX(),SY(),MX(),MY()の処理カウント
- P<br>P()のどちらを使うフェーズか
- R<br>MSX0の向き 0↑ 1→ 2↓ 3←
- RN<br>次回の↑
- T<br>移動処理用 処理中のS(),C(),D()
- S<br>移動処理用 スレッド状態確認用
- I<br>ループ汎用
- X,Y<br>座標汎用
- Xn,Yn<br>記号の座標(時刻のコロン、日付のピリオド)
- V<br>VRAM読み書き汎用
- A<br>汎用
- S$<br>スプライト定義用
- TM$<br>時刻取得用
- TS<br>前回取得秒


## プログラムの流れ
- 初期化処理
- 開始処理
- メインループ
  - HH:NNの文字パターンを配列変数へ
  - 本体の向き別の表示処理
    - →が上なら温度と湿度を表示
    - ↓が上なら日付を表示
    - ←が上なら西暦と日付を表示
  - 時刻を表示
  - 本体の向き別のコロン・ピリオドの位置計算
  - 本体の向き取得ループ
    - 本体の向きが変わらないなら秒を表示
    - 本体の向きが変わったなら1.5秒ほど様子見
    - 時刻が変わったら最優先で表示更新（メインループへ戻る）
  - 本体の向きが変わった処理
    - アニメーションに無関係なものを消す
      - コロン・ピリオド
      - 時刻以外の数字に使用している文字のパターンを消す
      - 時刻以外の数字に使用している文字を消す（本体の向きに応じて）
      - 時刻以外の数字に使用している文字のパターンを復活させておく
    - アニメーション準備処理
      - アニメーション用配列データ（移動元・移動先）を用意
      - 移動順用配列データを用意
    - アニメーション用ループ
      - 空きスレッドがあれば初期化し、走らせる
      - 移動処理
      - すべて処理し終えたらメインループへ戻る
- サブルーチン
  - 1文字を表示する
    - 引数：NN:文字(0-9,-,c,%) NX,NY:表示位置 NP:表示に使う文字(0,1,2)
    - 戻し値：なし
    - 使用変数：NI,NJ:ループ
  - 回転後の座標を変換
    - 引数：R:向き X,Y:変換前座標
    - 戻し値：RX,RY:変換後座標
  - MSX0の向きを取得する
    - 引数：なし
    - 戻し値：AR:取得した向き
    - 使用変数：AX,AY:加速度センサの値用
  - IOTGET代替処理
    - 引数：ID$:デバイスID
    - 戻し値：IR:センサから取得した値
    - 使用変数：IC:I/Oポート番号
  - 日付・時刻の取得
    - 引数：なし
    - 戻し値：CY,CM,CD,CH,CN,CS,CT$
    - 使用変数：CA,CB:BDOSコール戻り値取得用

## すぺさん
MSX0のCALL IOTGET()相当の機能の実装は、HRA!さん(https://github.com/hra1129 )のX(Twitter)の投稿、DEKOさんの[Turbo Pascal用ライブラリ](https://qiita.com/ht_deko/items/a5c0bf6e7969093beb3c )を参考にさせていただきました。この場を借りてお礼申し上げます。

## あとがき
- 図書館司書資格が取得できた記念に作りました。本当は、MSX0を入手した頃からずっと作りたかったのです。
- べーしっ君のインライン機械語を（多分）初めて使いました。便利です。
- 最適化っぽいことはあまりしていません。べーしっ君速すぎ。
- 変数の解説やプログラムの流れを書くのはファンダムの記事みたいで楽しいです。
